name: iOS Build

on:
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    name: Build and Check Syntax
    runs-on: macos-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Xcode version
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Build
        id: build
        continue-on-error: true
        run: |
          set +e
          xcodebuild build \
            -project SampattiTrack/SampattiTrack.xcodeproj \
            -scheme SampattiTrack \
            -destination 'platform=iOS Simulator,name=iPhone 17' \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            2>&1 | tee build_output.log
          
          BUILD_EXIT_CODE=${PIPESTATUS[0]}
          echo "exit_code=$BUILD_EXIT_CODE" >> $GITHUB_OUTPUT
          exit $BUILD_EXIT_CODE

      - name: Extract and Post Build Errors
        if: steps.build.outputs.exit_code != '0'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const buildOutput = fs.readFileSync('build_output.log', 'utf8');
            
            // Extract error lines
            const errorLines = buildOutput.split('\n').filter(line => 
              line.includes('error:') || 
              line.includes('** BUILD FAILED **') ||
              line.includes('The following build commands failed:')
            );
            
            // Get context around errors (5 lines before and after each error)
            const lines = buildOutput.split('\n');
            const errorContext = [];
            const processedIndices = new Set();
            
            lines.forEach((line, index) => {
              if (line.includes('error:')) {
                const start = Math.max(0, index - 5);
                const end = Math.min(lines.length, index + 6);
                
                for (let i = start; i < end; i++) {
                  if (!processedIndices.has(i)) {
                    errorContext.push(lines[i]);
                    processedIndices.add(i);
                  }
                }
                if (end < lines.length && !processedIndices.has(index + 6)) {
                  errorContext.push('...');
                }
              }
            });
            
            // Build the comment body
            let commentBody = '## âŒ iOS Build Failed\n\n';
            commentBody += '### Build Errors\n\n';
            
            if (errorLines.length > 0) {
              commentBody += '```\n';
              commentBody += errorLines.slice(0, 20).join('\n'); // Limit to first 20 error lines
              if (errorLines.length > 20) {
                commentBody += '\n... and ' + (errorLines.length - 20) + ' more errors';
              }
              commentBody += '\n```\n\n';
            }
            
            if (errorContext.length > 0) {
              commentBody += '### Error Context\n\n';
              commentBody += '```\n';
              commentBody += errorContext.slice(0, 50).join('\n'); // Limit context
              if (errorContext.length > 50) {
                commentBody += '\n... (truncated)';
              }
              commentBody += '\n```\n\n';
            }
            
            commentBody += '> ðŸ’¡ **Tip**: Review the [full build log](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for complete details.\n';
            
            // Post comment to PR
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });

      - name: Post Success Comment
        if: steps.build.outputs.exit_code == '0'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## âœ… iOS Build Succeeded\n\nThe build completed successfully with no errors!'
            });

      - name: Fail Job if Build Failed
        if: steps.build.outputs.exit_code != '0'
        run: exit 1
